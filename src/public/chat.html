<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GossipKaro Chat</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      overflow: hidden;
    }

    /* Auth Screen */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .auth-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    .auth-box h1 {
      text-align: center;
      color: #075e54;
      margin-bottom: 30px;
      font-size: 32px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5ddd5;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      color: #667781;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: #075e54;
      border-bottom-color: #25d366;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-form input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .auth-form button {
      width: 100%;
      padding: 12px;
      background: #25d366;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .auth-form button:hover {
      background: #20ba5a;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }

    /* Main Chat Layout */
    .main-container {
      display: none;
      height: 100vh;
      flex-direction: row;
    }

    /* Sidebar */
    .sidebar {
      width: 350px;
      background: white;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      background: #075e54;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h2 {
      font-size: 18px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .header-actions button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .header-actions button:hover {
      background: rgba(255,255,255,0.3);
    }

    .groups-list {
      flex: 1;
      overflow-y: auto;
    }

    .group-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f0f2f5;
      cursor: pointer;
      transition: background 0.2s;
    }

    .group-item:hover {
      background: #f5f6f6;
    }

    .group-item.active {
      background: #e5ddd5;
    }

    .group-name {
      font-weight: 600;
      color: #000;
      margin-bottom: 5px;
    }

    .group-description {
      font-size: 13px;
      color: #667781;
    }

    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #667781;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
    }

    .no-chat-selected {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #667781;
      font-size: 18px;
    }

    .chat-container {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .chat-container.active {
      display: flex;
    }

    .chat-header {
      background: #075e54;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h3 {
      font-size: 18px;
    }

    .chat-header-info {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }

    .leave-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .leave-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .header-actions button {
      margin-left: 8px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .header-actions button:first-child,
    .header-actions button:nth-child(2) {
      background: #25d366;
      color: white;
    }

    .header-actions button:first-child:hover,
    .header-actions button:nth-child(2):hover {
      background: #20ba5a;
    }

    .header-actions button:last-child {
      background: #dc3545;
      color: white;
    }

    .header-actions button:last-child:hover {
      background: #c82333;
    }

    .messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }

    .message.sent {
      align-items: flex-end;
    }

    .message.received {
      align-items: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 8px;
      word-wrap: break-word;
    }

    .message.sent .message-bubble {
      background: #dcf8c6;
    }

    .message.received .message-bubble {
      background: white;
    }

    .message-sender {
      font-size: 12px;
      font-weight: bold;
      color: #075e54;
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 11px;
      color: #667781;
      margin-top: 4px;
    }

    .typing-indicator {
      padding: 10px 20px;
      font-size: 13px;
      color: #667781;
      font-style: italic;
      min-height: 30px;
    }

    .message-input {
      display: flex;
      padding: 10px;
      background: #f0f2f5;
      border-top: 1px solid #ddd;
    }

    .message-input input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 20px;
      background: white;
      margin-right: 10px;
      font-size: 14px;
    }

    .message-input button {
      padding: 12px 24px;
      background: #25d366;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #075e54;
    }

    .modal-content input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-cancel {
      background: #f0f2f5;
      color: #667781;
    }

    .btn-submit {
      background: #25d366;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box">
      <h1>üó£Ô∏è GossipKaro</h1>
      
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchTab('login')">Login</div>
        <div class="auth-tab" onclick="switchTab('register')">Register</div>
      </div>

      <!-- Login Form -->
      <div class="auth-form active" id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <div class="error" id="loginError"></div>
      </div>

      <!-- Register Form -->
      <div class="auth-form" id="registerForm">
        <input type="text" id="registerUsername" placeholder="Username" required>
        <input type="email" id="registerEmail" placeholder="Email" required>
        <input type="password" id="registerPassword" placeholder="Password" required>
        <button onclick="register()">Register</button>
        <div class="error" id="registerError"></div>
      </div>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div class="main-container" id="mainScreen">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 id="currentUsername">Chats</h2>
        <div class="header-actions">
          <button onclick="openCreateGroupModal()">+ New Group</button>
          <button onclick="openJoinGroupModal()">Join</button>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="groups-list" id="groupsList">
        <div class="empty-state">No groups yet. Create or join one!</div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
      <div class="no-chat-selected" id="noChatSelected">
        Select a group to start chatting
      </div>
      <div class="chat-container" id="chatContainer">
        <div class="chat-header">
          <div>
            <h3 id="currentGroupName">Group Name</h3>
            <div class="chat-header-info" id="currentGroupInfo">0 members</div>
          </div>
          <div class="header-actions">
            <button class="leave-btn" onclick="generateInviteLink()">üìã Invite Link</button>
            <button class="leave-btn" onclick="leaveCurrentGroup()">Leave Group</button>
          </div>
        </div>
        <div class="messages" id="messages"></div>
        <div class="typing-indicator" id="typingIndicator"></div>
        <div class="message-input">
          <input 
            type="text" 
            id="messageInput" 
            placeholder="Type a message..."
            onkeypress="handleKeyPress(event)"
            oninput="handleTyping()"
          >
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Group Modal -->
  <div class="modal" id="createGroupModal">
    <div class="modal-content">
      <h3>Create New Group</h3>
      <input type="text" id="newGroupName" placeholder="Group Name" required>
      <input type="text" id="newGroupDesc" placeholder="Description (optional)">
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        <button class="btn-submit" onclick="createGroup()">Create</button>
      </div>
      <div class="error" id="createGroupError"></div>
    </div>
  </div>

  <!-- Join Group Modal -->
  <div class="modal" id="joinGroupModal">
    <div class="modal-content">
      <h3>Join Group</h3>
      <input type="text" id="inviteCode" placeholder="Enter Invite Code" required>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModals()">Cancel</button>
        <button class="btn-submit" onclick="joinGroup()">Join</button>
      </div>
      <div class="error" id="joinGroupError"></div>
    </div>
  </div>

  <script>
    let socket = null;
    let currentUser = null;
    let currentGroupId = null;
    let userGroups = [];
    let authToken = null;
    let typingTimeout = null;

    // Check for saved authentication on page load
    async function checkAuth() {
      const savedToken = localStorage.getItem('authToken');
      const savedUser = localStorage.getItem('currentUser');

      if (savedToken && savedUser) {
        try {
          // Verify token is still valid by fetching groups
          const response = await fetch('http://localhost:5000/api/groups', {
            headers: { 'Authorization': `Bearer ${savedToken}` }
          });

          if (response.ok) {
            // Token is valid, auto-login
            authToken = savedToken;
            currentUser = JSON.parse(savedUser);

            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            document.getElementById('currentUsername').textContent = currentUser.username || currentUser.email;

            connectSocket(authToken);
            await loadUserGroups();
          } else {
            // Token invalid, clear storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
        }
      }
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Disconnect socket
        if (socket) {
          socket.disconnect();
        }

        // Clear storage
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');

        // Reset state
        authToken = null;
        currentUser = null;
        currentGroupId = null;
        userGroups = [];

        // Show auth screen
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';

        // Clear forms
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';

        // Clear chat area
        document.getElementById('messages').innerHTML = '';
        document.getElementById('groupsList').innerHTML = '';
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', checkAuth);

    // Check for saved authentication on page load
    async function checkAuth() {
      const savedToken = localStorage.getItem('authToken');
      const savedUser = localStorage.getItem('currentUser');

      if (savedToken && savedUser) {
        try {
          // Verify token is still valid by fetching groups
          const response = await fetch('http://localhost:5000/api/groups', {
            headers: { 'Authorization': `Bearer ${savedToken}` }
          });

          if (response.ok) {
            // Token is valid, auto-login
            authToken = savedToken;
            currentUser = JSON.parse(savedUser);

            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            document.getElementById('currentUsername').textContent = currentUser.username || currentUser.email;

            connectSocket(authToken);
            await loadUserGroups();
          } else {
            // Token invalid, clear storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
        }
      }
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Disconnect socket
        if (socket) {
          socket.disconnect();
        }

        // Clear storage
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');

        // Reset state
        authToken = null;
        currentUser = null;
        currentGroupId = null;
        userGroups = [];

        // Show auth screen
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';

        // Clear forms
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';

        // Clear chat area
        document.getElementById('messages').innerHTML = '';
        document.getElementById('groupsList').innerHTML = '';
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', checkAuth);

    // Switch between login/register tabs
    function switchTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelectorAll('.auth-tab')[0].classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('registerForm').classList.add('active');
      }
    }

    // Register
    async function register() {
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const errorEl = document.getElementById('registerError');

      if (!username || !email || !password) {
        errorEl.textContent = 'Please fill all fields';
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.message || 'Registration failed';
          return;
        }

        // Save to localStorage
        authToken = data.data.accessToken;
        currentUser = data.data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        // Switch to main screen
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'flex';
        document.getElementById('currentUsername').textContent = currentUser.username || currentUser.email;

        // Connect socket
        connectSocket(authToken);

        // Load user's groups
        await loadUserGroups();

        errorEl.textContent = '';

      } catch (error) {
        errorEl.textContent = 'Connection error';
        console.error(error);
      }
    }

    // Login
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      if (!email || !password) {
        errorEl.textContent = 'Please fill all fields';
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.message || 'Login failed';
          return;
        }

        authToken = data.data.accessToken;
        currentUser = data.data.user;

        // Save to localStorage
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        console.log('Logged in user:', currentUser); // Debug log

        // Switch to main screen
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'flex';
        document.getElementById('currentUsername').textContent = currentUser.username || currentUser.email;

        // Connect socket
        connectSocket(authToken);

        // Load user's groups
        await loadUserGroups();

        errorEl.textContent = '';

      } catch (error) {
        errorEl.textContent = 'Connection error';
        console.error(error);
      }
    }

    // Connect Socket
    function connectSocket(token) {
      socket = io('http://localhost:5000', {
        auth: { token }
      });

      socket.on('connect', () => {
        console.log('Connected:', socket.id);
      });

      socket.on('new-message', (msg) => {
        if (msg.group === currentGroupId) {
          displayMessage(msg);
        }
      });

      socket.on('user-typing', ({ username }) => {
        if (currentGroupId) {
          showTypingIndicator(username);
        }
      });

      socket.on('user-stopped-typing', () => {
        hideTypingIndicator();
      });

      socket.on('error', (err) => {
        console.error('Socket error:', err);
      });
    }

    // Load user's groups
    async function loadUserGroups() {
      try {
        const response = await fetch('http://localhost:5000/api/groups', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const data = await response.json();

        if (data.data) {
          userGroups = data.data;
          displayGroups();
        }
      } catch (error) {
        console.error('Failed to load groups:', error);
      }
    }

    // Display groups in sidebar
    function displayGroups() {
      const groupsList = document.getElementById('groupsList');

      if (userGroups.length === 0) {
        groupsList.innerHTML = '<div class="empty-state">No groups yet. Create or join one!</div>';
        return;
      }

      groupsList.innerHTML = userGroups.map(group => `
        <div class="group-item" onclick="selectGroup('${group._id}')">
          <div class="group-name">${group.groupName}</div>
          <div class="group-description">${group.description || 'No description'}</div>
        </div>
      `).join('');
    }

    // Select a group
    async function selectGroup(groupId) {
      currentGroupId = groupId;

      // Update UI
      document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.group-item').classList.add('active');

      document.getElementById('noChatSelected').style.display = 'none';
      document.getElementById('chatContainer').classList.add('active');

      // Load group details
      const group = userGroups.find(g => g._id === groupId);
      document.getElementById('currentGroupName').textContent = group.groupName;
      document.getElementById('currentGroupInfo').textContent = `${group.members.length} members`;

      // Clear previous messages
      document.getElementById('messages').innerHTML = '';

      // Join group room
      socket.emit('join-group', groupId);

      // Load messages
      await loadMessages(groupId);
    }

    // Load messages
    async function loadMessages(groupId) {
      try {
        const response = await fetch(
          `http://localhost:5000/api/groups/${groupId}/messages`,
          { headers: { 'Authorization': `Bearer ${authToken}` } }
        );

        const data = await response.json();

        if (data.data && data.data.messages) {
          data.data.messages.forEach(msg => displayMessage(msg, false));
        }
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }

    // Display message
    function displayMessage(msg, scroll = true) {
      const messagesDiv = document.getElementById('messages');
      const messageEl = document.createElement('div');

      // Determine if message was sent by current user
      let isSent = false;
      let senderName = 'Unknown';

      if (msg.sender) {
        if (typeof msg.sender === 'object') {
          // Sender is populated object
          isSent = msg.sender._id === currentUser._id;
          senderName = msg.sender.username || msg.sender.email || 'Unknown';
        } else {
          // Sender is just an ID string
          isSent = msg.sender === currentUser._id;
          senderName = isSent ? (currentUser.username || currentUser.email) : 'Unknown';
        }
      }

      messageEl.className = `message ${isSent ? 'sent' : 'received'}`;

      const time = new Date(msg.createdAt).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });

      messageEl.innerHTML = `
        ${!isSent ? `<div class="message-sender">${senderName}</div>` : ''}
        <div class="message-bubble">
          ${msg.content}
          <div class="message-time">${time}</div>
        </div>
      `;

      messagesDiv.appendChild(messageEl);

      if (scroll) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }

    // Send message
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content || !currentGroupId) return;

      socket.emit('send-message', {
        groupId: currentGroupId,
        content
      });

      input.value = '';
      socket.emit('stop-typing', { groupId: currentGroupId });
      hideTypingIndicator();
    }

    // Handle Enter key
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Handle typing
    function handleTyping() {
      if (!currentGroupId) return;

      socket.emit('typing', { groupId: currentGroupId });

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('stop-typing', { groupId: currentGroupId });
      }, 2000);
    }

    // Show typing indicator
    function showTypingIndicator(username) {
      const indicator = document.getElementById('typingIndicator');
      indicator.textContent = `${username} is typing...`;
    }

    // Hide typing indicator
    function hideTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      indicator.textContent = '';
    }

    // Create Group Modal
    function openCreateGroupModal() {
      document.getElementById('createGroupModal').classList.add('active');
    }

    function openJoinGroupModal() {
      document.getElementById('joinGroupModal').classList.add('active');
    }

    function closeModals() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    // Create Group
    async function createGroup() {
      const groupName = document.getElementById('newGroupName').value;
      const description = document.getElementById('newGroupDesc').value;
      const errorEl = document.getElementById('createGroupError');

      if (!groupName) {
        errorEl.textContent = 'Group name is required';
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/api/groups/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ groupName, description })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.message || 'Failed to create group';
          return;
        }

        closeModals();
        await loadUserGroups();
        errorEl.textContent = '';

      } catch (error) {
        errorEl.textContent = 'Connection error';
        console.error(error);
      }
    }

    // Join Group
    async function joinGroup() {
      const inviteCode = document.getElementById('inviteCode').value;
      const errorEl = document.getElementById('joinGroupError');

      if (!inviteCode) {
        errorEl.textContent = 'Invite code is required';
        return;
      }

      try {
        const response = await fetch(`http://localhost:5000/api/invites/join/${inviteCode}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.message || 'Failed to join group';
          return;
        }

        closeModals();
        await loadUserGroups();
        errorEl.textContent = '';

      } catch (error) {
        errorEl.textContent = 'Connection error';
        console.error(error);
      }
    }

    // Leave current group
    async function leaveCurrentGroup() {
      if (!currentGroupId || !confirm('Are you sure you want to leave this group?')) return;

      try {
        const response = await fetch(
          `http://localhost:5000/api/groups/${currentGroupId}/leave`,
          {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
          }
        );

        if (response.ok) {
          currentGroupId = null;
          document.getElementById('noChatSelected').style.display = 'flex';
          document.getElementById('chatContainer').classList.remove('active');
          await loadUserGroups();
        }
      } catch (error) {
        console.error('Failed to leave group:', error);
      }
    }

    // Logout
    function logout() {
      if (socket) socket.disconnect();
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('mainScreen').style.display = 'none';
      currentUser = null;
      authToken = null;
      currentGroupId = null;
      userGroups = [];
    }

    // Generate and copy invite link
    async function generateInviteLink() {
      if (!currentGroupId) return;

      try {
        const response = await fetch('http://localhost:5000/api/invites/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ 
            groupId: currentGroupId,
            expiresInDays: 7
          })
        });

        const data = await response.json();

        if (!response.ok) {
          alert('Failed to generate invite link');
          return;
        }

        const inviteCode = data.data.code;
        const inviteUrl = `${window.location.origin}/join/${inviteCode}`;

        try {
          await navigator.clipboard.writeText(inviteUrl);
          alert('Invite link copied to clipboard');
        } catch (err) {
          // Fallback: show the link so user can copy it manually
          prompt('Copy invite link:', inviteUrl);
        }

      } catch (error) {
        console.error('Failed to generate invite:', error);
        alert('Connection error');
      }
    }
  </script>
</body>
</html>